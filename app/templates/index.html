{% extends "base.html" %}

<head>
  {% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
  {% endblock %}
</head>

<body>
{% block content %}
<div class="chat-container">
  <div class="chat-header">AI ChatBot</div>
  <div id="chat-window" class="chat-window"></div>

  <form id="chat-form">
    <textarea id="question" placeholder="Type your question..." required></textarea>
    <button type="submit">Send</button>
    <button type="button" id="cancel-button" style="display:none;">Cancel</button>
  </form>
</div>
<script>
  const form = document.getElementById('chat-form');
  const chatWindow = document.getElementById('chat-window');
  const cancelButton = document.getElementById('cancel-button');

  let controller = null;

  function addMessage(sender, text) {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message', sender);
    msgDiv.innerText = text;
    chatWindow.appendChild(msgDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const questionInput = document.getElementById('question');
    const question = questionInput.value.trim();
    if (!question) return;

    addMessage('user', question);
    questionInput.value = '';

    const botMsgDiv = document.createElement('div');
    botMsgDiv.classList.add('message', 'bot');
    botMsgDiv.innerText = '';
    chatWindow.appendChild(botMsgDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    // Track if any text was added
    let receivedAnyContent = false;

    // AbortController for cancel support
    controller = new AbortController();
    const signal = controller.signal;

    cancelButton.style.display = 'inline';
    cancelButton.disabled = false;
    cancelButton.innerText = 'Cancel';

    cancelButton.onclick = () => {
      if (controller) {
        controller.abort();
        cancelButton.disabled = true;
        cancelButton.innerText = 'Canceled';
      }
    };

    try {
      const res = await fetch('/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ question }),
        signal
      });

      const reader = res.body.getReader();
      const decoder = new TextDecoder('utf-8');
      let done = false;

      while (!done) {
        const { value, done: doneReading } = await reader.read();
        done = doneReading;



        if (value) {
          let chunk = decoder.decode(value);

          if (chunk.endsWith('\n\n')) {
            chunk = chunk.slice(0, -2);
          }

          if (chunk.startsWith('data: ')) {
            chunk = chunk.replace('data: ', '');
          }
          try {

              const data = JSON.parse(chunk);
              receivedAnyContent = true;

              if (data.type === 'text') {
                botMsgDiv.innerText += data.content;
              } else if (data.type === 'question') {
                botMsgDiv.classList.add('question');
                botMsgDiv.id = data.question_id

                // Create and add question text
                const questionText = document.createElement('div');
                questionText.className = 'question-text';
                questionText.innerText = data.content;
                botMsgDiv.appendChild(questionText);

                // Create form for choices
                const choiceForm = document.createElement('div');
                choiceForm.className = 'choice-form';
                let buttons = []

                data.choices.forEach(choice => {
                  const button = document.createElement('button');
                  buttons.push(button)
                  button.className = 'choice-button';

                  if (choice) {
                      choice = choice.charAt(0).toUpperCase() + choice.slice(1);
                  }

                  button.innerText = choice;

                  button.onclick = () => {
                    // addMessage('user', choice); // Show choice in chat
                    // questionInput.value = choice;
                    // form.dispatchEvent(new Event('submit'));
                    // botMsgDiv.classList.remove('question');
                    // choiceForm.remove(); // remove form after answer
                      fetch('/answer', {
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ "question_id": data.question_id, "answer": choice }),
                        signal
                      }).then(response => {
                          if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                          }
                          button.style.color = "green"
                          buttons.forEach((btn) => {
                              btn.disabled = true
                          })

                          return response.json();  // or response.text(), etc.
                        })
                        .then(data => {
                          console.log('Response data:', data);
                        })
                        .catch(error => {
                          console.error('Fetch error:', error);
                        });
                  };

                  choiceForm.appendChild(button);
                });

                botMsgDiv.appendChild(choiceForm);
              }

              chatWindow.scrollTop = chatWindow.scrollHeight;
          } catch (err) {
              console.error("error parsing chunk" + chunk + "\n" + err)
          }
        }
      }

    } catch (err) {
      if (err.name === 'AbortError') {
        if (!receivedAnyContent) {
          botMsgDiv.remove(); // Remove empty bubble if nothing was streamed
        } else {
          botMsgDiv.innerText += '\n[Stream canceled]';
        }
      } else {
        botMsgDiv.innerText = 'Error connecting to server.';
      }
    } finally {
      cancelButton.style.display = 'none';
      cancelButton.innerText = 'Cancel';
    }
  });
</script>

{% endblock %}
</body>
