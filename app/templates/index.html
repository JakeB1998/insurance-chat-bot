{% extends "base.html" %}

<head>
    {% block head %}

    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    {% endblock %}
</head>
<body>
  {% block content %}
<div class="chat-container">
    <div class="chat-header">AI ChatBot</div>
    <div id="chat-window" class="chat-window"></div>

    <form id="chat-form">
      <textarea id="question" placeholder="Type your question..." required></textarea>
      <button type="submit">Send</button>
    </form>
</div>

  <script>
    const form = document.getElementById('chat-form');
    const chatWindow = document.getElementById('chat-window');

    function addMessage(sender, text) {
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('message', sender);
      msgDiv.innerText = text;
      chatWindow.appendChild(msgDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

   form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const questionInput = document.getElementById('question');
      const question = questionInput.value.trim();
      if (!question) return;

      addMessage('user', question);
      questionInput.value = '';

      const botMsgDiv = document.createElement('div');
      botMsgDiv.classList.add('message', 'bot');
      botMsgDiv.innerText = '';
      chatWindow.appendChild(botMsgDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ question })
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let done = false;

        while (!done) {
          const { value, done: doneReading } = await reader.read();
          done = doneReading;

          if (value) {
            var chunk = decoder.decode(value);

            if (chunk.endsWith('\n\n')) {
                  chunk = chunk.slice(0, -2);  // remove last 2 chars
            }

            if (chunk.startsWith('data: ')) {
                chunk = chunk.replace('data: ', '')
            }
            botMsgDiv.innerText += chunk
            chatWindow.scrollTop = chatWindow.scrollHeight;

          }
        }
      } catch (err) {
        botMsgDiv.innerText = 'Error connecting to server.';
      }
    });

  </script>
{% endblock %}
</body>

